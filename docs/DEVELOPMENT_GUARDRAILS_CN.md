# QtScrcpy 开发过程防反复修改规则

## 目标
- 降低“反复改、推翻重改、回归缺陷”的概率。
- 每次修改都能回答三个问题：为什么改、改了什么、如何证明没引入新问题。

## 强制流程（不可跳过）
1. 先复现再改代码
- 必须先拿到可复现现象（报错信息、日志、截图、命令输出至少一种）。
- 不能在“猜测未验证”状态直接提交修复。

2. 先定根因再动手
- 至少写出 1 条明确根因（模块/函数/依赖缺失/状态机错误）。
- 若根因不确定，先加日志和最小探针，不直接做功能性大改。

3. 最小改动原则
- 单次提交只解决一个核心问题，避免把多个问题混在一起。
- 优先局部修复，避免无证据的大范围重构。

4. 改后必须验证
- 至少执行对应验证（编译、启动、关键路径、回归点）。
- 对外发布前必须通过 `scripts/preflight_windows.ps1`。

5. 留下证据
- 只要改了 `QtScrcpy/src` 核心代码，必须新增/更新一份 `docs/change-notes/*.md`。
- 记录根因、修改点、验证结果、风险和回滚方法。

## 禁止项
- 未复现直接改。
- 没有根因说明就提交“尝试性大改”。
- 无验证证据就推送和发布。
- 一次提交同时做“修复 + 重构 + 风格清理”。

## 提交粒度建议
- 一个问题一个提交（atomic commit）。
- 提交信息建议结构：
  - `fix(runtime): ...`
  - `fix(ui): ...`
  - `chore(ci): ...`

## 发布门禁
- CI 必须通过：
  - `Change note gate`（改核心代码必须附变更记录）
  - `Preflight package gate`（发布包依赖完整性）
- 任一门禁失败，不允许发布资产覆盖。
