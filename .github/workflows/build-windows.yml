name: Build QtScrcpy Windows EXE

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "QtScrcpy/**"
      - ".github/workflows/build-windows.yml"

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install Qt 6 (cloud)
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.6.3"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2019_64"
          modules: "qtmultimedia"
          cache: true

      - name: Enable MSVC toolchain
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Ensure Build Uses Trigger SHA
        shell: powershell
        run: |
          git checkout --force $env:GITHUB_SHA
          git rev-parse HEAD

      - name: Change note gate (source changes require evidence)
        if: github.event_name == 'push'
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $changed = @()
          try {
            $changed = @(git diff --name-only HEAD~1 HEAD)
          } catch {
            Write-Host "No previous commit available for diff, skipping gate."
            exit 0
          }

          if ($changed.Count -eq 0) {
            Write-Host "No file changes detected."
            exit 0
          }

          $srcChanged = $changed | Where-Object {
            $_ -like "QtScrcpy/src/*" -or
            $_ -eq "QtScrcpy/CMakeLists.txt" -or
            $_ -eq "QtScrcpy/src/main.cpp"
          }

          if (!$srcChanged -or $srcChanged.Count -eq 0) {
            Write-Host "No core source changes. Gate passed."
            exit 0
          }

          $noteChanged = $changed | Where-Object { $_ -like "docs/change-notes/*.md" }
          if (!$noteChanged -or $noteChanged.Count -eq 0) {
            Write-Host "Changed source files:"
            $srcChanged | ForEach-Object { Write-Host " - $_" }
            throw "Source code changed but no docs/change-notes/*.md update found. Add a change note with root cause and validation evidence."
          }

          Write-Host "Source change evidence files:"
          $noteChanged | ForEach-Object { Write-Host " - $_" }
          Write-Host "Change note gate passed."

      - name: Configure CMake
        run: cmake -S QtScrcpy -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Package runtime files
        shell: powershell
        run: |
          $outDir = (Resolve-Path "build").Path
          $exe = Join-Path $outDir "QtScrcpy.exe"
          if (!(Test-Path $exe)) {
            throw "QtScrcpy.exe not found in $outDir"
          }

          windeployqt --release --compiler-runtime $exe

          # ADB runtime (adb.exe + required DLLs)
          $adbDir = Join-Path $outDir "adb"
          New-Item -ItemType Directory -Force -Path $adbDir | Out-Null

          if (Test-Path "QtScrcpy/third_party/adb") {
            Copy-Item "QtScrcpy/third_party/adb/*" $adbDir -Recurse -Force -ErrorAction SilentlyContinue
          }

          $adbExe = Join-Path $adbDir "adb.exe"
          if (!(Test-Path $adbExe)) {
            $adbZipUrl = "https://github.com/Genymobile/scrcpy/releases/download/v2.4/scrcpy-win64-v2.4.zip"
            Write-Host "adb.exe not found in repo. Downloading ADB from scrcpy package: $adbZipUrl"

            $tmpAdbDir = Join-Path $env:RUNNER_TEMP "scrcpy-adb"
            if (Test-Path $tmpAdbDir) {
              Remove-Item $tmpAdbDir -Recurse -Force
            }
            New-Item -ItemType Directory -Force -Path $tmpAdbDir | Out-Null

            $zipPath = Join-Path $tmpAdbDir "scrcpy-win64.zip"
            Invoke-WebRequest -Uri $adbZipUrl -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath $tmpAdbDir -Force

            $foundAdb = Get-ChildItem -Path $tmpAdbDir -Recurse -Filter "adb.exe" -File | Select-Object -First 1
            if (!$foundAdb) {
              throw "Failed to find adb.exe in scrcpy package"
            }
            $scrcpyRoot = Split-Path $foundAdb.FullName -Parent
            Write-Host "Using adb files from: $scrcpyRoot"

            foreach ($name in @("adb.exe", "AdbWinApi.dll", "AdbWinUsbApi.dll")) {
              $src = Join-Path $scrcpyRoot $name
              if (!(Test-Path $src)) {
                throw "Missing $name in scrcpy package at $scrcpyRoot"
              }
              Copy-Item $src $adbDir -Force
            }
          }

          foreach ($name in @("adb.exe", "AdbWinApi.dll", "AdbWinUsbApi.dll")) {
            $p = Join-Path $adbDir $name
            if (!(Test-Path $p)) {
              throw "ADB file missing in output directory: adb/$name"
            }
          }
          foreach ($name in @("adb.exe", "AdbWinApi.dll", "AdbWinUsbApi.dll")) {
            Copy-Item (Join-Path $adbDir $name) (Join-Path $outDir $name) -Force
            $rootPath = Join-Path $outDir $name
            if (!(Test-Path $rootPath)) {
              throw "ADB fallback file missing in output directory root: $name"
            }
          }
          Write-Host "ADB files present:"
          Get-ChildItem -Path $adbDir -File | Select-Object Name,Length | Format-Table -AutoSize
          Write-Host "ADB fallback files present in root:"
          Get-ChildItem -Path $outDir -File -Filter "adb*.exe" | Select-Object Name,Length | Format-Table -AutoSize

          # Verify ADB can run (avoid shipping a package that can't connect USB/WiFi).
          $adbText = (& $adbExe version 2>&1 | Out-String)
          if ($LASTEXITCODE -ne 0) {
            throw "adb.exe failed to run (exit $LASTEXITCODE). Output: $adbText"
          }
          if ($adbText -notmatch "Android Debug Bridge") {
            throw "Unexpected adb.exe output. Output: $adbText"
          }
          Write-Host "adb.exe verified:"
          Write-Host $adbText
          Copy-Item "QtScrcpy/resources/scrcpy-server" (Join-Path $outDir "scrcpy-server") -Force

          # FFmpeg runtime (DLLs)
          #
          # The project links to the import libs in QtScrcpy/third_party/ffmpeg/lib, which
          # require the corresponding FFmpeg shared DLLs to be placed next to QtScrcpy.exe.
          $ffmpegDlls = @(
            "avcodec-62.dll",
            "avdevice-62.dll",
            "avfilter-11.dll",
            "avformat-62.dll",
            "avutil-60.dll",
            "swresample-6.dll",
            "swscale-9.dll"
          )

          function Copy-DllsFromDir([string]$srcDir, [string]$dstDir, [string[]]$names) {
            foreach ($dll in $names) {
              $src = Join-Path $srcDir $dll
              if (Test-Path $src) {
                Copy-Item $src $dstDir -Force
              }
            }
          }

          if (Test-Path "QtScrcpy/third_party/ffmpeg/bin") {
            Copy-DllsFromDir -srcDir "QtScrcpy/third_party/ffmpeg/bin" -dstDir $outDir -names $ffmpegDlls
          }

          $missing = @()
          foreach ($dll in $ffmpegDlls) {
            if (!(Test-Path (Join-Path $outDir $dll))) {
              $missing += $dll
            }
          }

          if ($missing.Count -gt 0) {
            $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl-shared.zip"
            Write-Host "FFmpeg DLLs missing after local copy: $($missing -join ', ')"
            Write-Host "Downloading FFmpeg shared build: $ffmpegUrl"

            $tmpDir = Join-Path $env:RUNNER_TEMP "ffmpeg-shared"
            if (Test-Path $tmpDir) {
              Remove-Item $tmpDir -Recurse -Force
            }
            New-Item -ItemType Directory -Force -Path $tmpDir | Out-Null

            $zipPath = Join-Path $tmpDir "ffmpeg.zip"
            Invoke-WebRequest -Uri $ffmpegUrl -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath $tmpDir -Force

            $avcodec = Get-ChildItem -Path $tmpDir -Recurse -Filter "avcodec-62.dll" -File | Select-Object -First 1
            if (!$avcodec) {
              throw "Failed to find avcodec-62.dll in FFmpeg build"
            }
            $ffmpegBinDir = Split-Path $avcodec.FullName -Parent
            Write-Host "Using FFmpeg DLL directory: $ffmpegBinDir"

            # Copy required FFmpeg core DLLs.
            foreach ($dll in $ffmpegDlls) {
              $src = Join-Path $ffmpegBinDir $dll
              if (!(Test-Path $src)) {
                throw "Missing $dll inside FFmpeg build at $ffmpegBinDir"
              }
              Copy-Item $src $outDir -Force
            }

            # Also copy any extra DLLs in the same directory (codec deps, etc.) to avoid 0xC0000135.
            Get-ChildItem -Path $ffmpegBinDir -Filter "*.dll" -File |
              ForEach-Object { Copy-Item $_.FullName $outDir -Force }
          }

          foreach ($dll in $ffmpegDlls) {
            $p = Join-Path $outDir $dll
            if (!(Test-Path $p)) {
              throw "FFmpeg DLL missing in output directory: $dll"
            }
          }
          Write-Host "FFmpeg DLLs present in build output:"
          foreach ($dll in $ffmpegDlls) {
            $p = Join-Path $outDir $dll
            $fi = Get-Item $p
            Write-Host "$($fi.Name) $($fi.Length)"
          }

          $releaseDir = Join-Path (Resolve-Path ".").Path "release"
          New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null
          $pkgDir = Join-Path $releaseDir "QtScrcpy-win-x64"
          if (Test-Path $pkgDir) {
            Remove-Item $pkgDir -Recurse -Force
          }
          New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
          Copy-Item "$outDir/*" $pkgDir -Recurse -Force

          foreach ($dll in $ffmpegDlls) {
            if (!(Test-Path (Join-Path $pkgDir $dll))) {
              throw "FFmpeg DLL missing in package directory: $dll"
            }
          }
          foreach ($name in @("adb\\adb.exe", "adb\\AdbWinApi.dll", "adb\\AdbWinUsbApi.dll", "adb.exe", "AdbWinApi.dll", "AdbWinUsbApi.dll")) {
            if (!(Test-Path (Join-Path $pkgDir $name))) {
              throw "ADB file missing in package directory: $name"
            }
          }

          $runDebugLines = @(
            '@echo off'
            'setlocal'
            'cd /d %~dp0'
            'echo === QtScrcpy debug run ===> log.txt'
            'echo %date% %time%>> log.txt'
            'echo --- adb version --- >> log.txt'
            'if exist adb\\adb.exe (adb\\adb.exe version 1>> log.txt 2>>&1) else (if exist adb.exe (adb.exe version 1>> log.txt 2>>&1) else (echo adb not found>> log.txt))'
            'set QT_DEBUG_PLUGINS=1'
            'set QT_LOGGING_TO_CONSOLE=1'
            'QtScrcpy.exe 1>> log.txt 2>>&1'
            'echo ExitCode=%errorlevel%>> log.txt'
            'pause'
          )
          Set-Content -Path (Join-Path $pkgDir "run_debug.bat") -Value $runDebugLines -Encoding ASCII

          $buildInfo = @(
            "GitHub Repo: $env:GITHUB_REPOSITORY"
            "GitHub SHA:  $env:GITHUB_SHA"
            "Run ID:      $env:GITHUB_RUN_ID"
            "Run Number:  $env:GITHUB_RUN_NUMBER"
            "Built At:    $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss K')"
          ) -join "`r`n"
          Set-Content -Path (Join-Path $pkgDir "BUILD_INFO.txt") -Value $buildInfo -Encoding ASCII

          $zipPath = Join-Path $releaseDir "QtScrcpy-win-x64.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          Compress-Archive -Path "$pkgDir/*" -DestinationPath $zipPath

      - name: Preflight package gate
        shell: powershell
        run: |
          .\scripts\preflight_windows.ps1 `
            -PackageDir "release/QtScrcpy-win-x64" `
            -ZipPath "release/QtScrcpy-win-x64.zip" `
            -MinZipSizeMB 50

      - name: Print package runtime summary
        shell: powershell
        run: |
          $pkgDir = "release/QtScrcpy-win-x64"
          Write-Host "== Runtime summary =="
          Get-ChildItem $pkgDir -File |
            Where-Object { $_.Name -match '^(QtScrcpy\.exe|adb\.exe|AdbWinApi\.dll|AdbWinUsbApi\.dll|avcodec-|avformat-|avutil-|swscale-|swresample-)' } |
            Sort-Object Name |
            Select-Object Name,Length |
            Format-Table -AutoSize

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QtScrcpy-win-x64
          path: |
            release/QtScrcpy-win-x64.zip
            release/QtScrcpy-win-x64/**

      - name: Publish asset to tagged release
        if: github.ref == 'refs/heads/main'
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $dateTag = (Get-Date).ToUniversalTime().ToString("yyyyMMdd")
          $dateText = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")
          $tag = "v3.0.0-delivery-$dateTag"
          $title = "QtScrcpy Delivery v3 ($dateText UTC)"
          $asset = "release/QtScrcpy-win-x64.zip"
          $max = 5
          $notes = @(
            "Automated Windows package build.",
            "",
            "- Commit: $env:GITHUB_SHA",
            "- Run ID: $env:GITHUB_RUN_ID",
            "- Run Number: $env:GITHUB_RUN_NUMBER"
          ) -join "`n"

          gh release view $tag *> $null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Release tag does not exist, creating: $tag"
            for ($i = 1; $i -le $max; $i++) {
              gh release create $tag --title $title --notes $notes --target $env:GITHUB_SHA
              if ($LASTEXITCODE -eq 0) {
                Write-Host "Release created: $tag"
                break
              }

              if ($i -eq $max) {
                throw "gh release create failed after $max attempts (exit code: $LASTEXITCODE)"
              }

              Start-Sleep -Seconds (5 * $i)
            }
          } else {
            Write-Host "Release already exists: $tag"
          }

          for ($i = 1; $i -le $max; $i++) {
            Write-Host "Uploading release asset to $tag (attempt $i/$max): $asset"
            gh release upload $tag $asset --clobber
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Upload succeeded."
              exit 0
            }

            if ($i -eq $max) {
              throw "gh release upload failed after $max attempts (exit code: $LASTEXITCODE)"
            }

            Start-Sleep -Seconds (5 * $i)
          }
