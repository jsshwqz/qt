name: Build QtScrcpy Windows EXE

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "QtScrcpy/**"
      - ".github/workflows/build-windows.yml"

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt 6 (cloud)
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.6.3"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2019_64"
          modules: "qtmultimedia"
          cache: true

      - name: Enable MSVC toolchain
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Ensure Build Uses Trigger SHA
        shell: powershell
        run: |
          git checkout --force $env:GITHUB_SHA
          git rev-parse HEAD

      - name: Configure CMake
        run: cmake -S QtScrcpy -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Package runtime files
        shell: powershell
        run: |
          $outDir = (Resolve-Path "build").Path
          $exe = Join-Path $outDir "QtScrcpy.exe"
          if (!(Test-Path $exe)) {
            throw "QtScrcpy.exe not found in $outDir"
          }

          windeployqt --release --compiler-runtime $exe

          New-Item -ItemType Directory -Force -Path (Join-Path $outDir "adb") | Out-Null
          Copy-Item "QtScrcpy/third_party/adb/*" (Join-Path $outDir "adb") -Recurse -Force
          Copy-Item "QtScrcpy/resources/scrcpy-server" (Join-Path $outDir "scrcpy-server") -Force

          # FFmpeg runtime (DLLs)
          #
          # The project links to the import libs in QtScrcpy/third_party/ffmpeg/lib, which
          # require the corresponding FFmpeg shared DLLs to be placed next to QtScrcpy.exe.
          $ffmpegDlls = @(
            "avcodec-62.dll",
            "avdevice-62.dll",
            "avfilter-11.dll",
            "avformat-62.dll",
            "avutil-60.dll",
            "swresample-6.dll",
            "swscale-9.dll"
          )

          function Copy-DllsFromDir([string]$srcDir, [string]$dstDir, [string[]]$names) {
            foreach ($dll in $names) {
              $src = Join-Path $srcDir $dll
              if (Test-Path $src) {
                Copy-Item $src $dstDir -Force
              }
            }
          }

          if (Test-Path "QtScrcpy/third_party/ffmpeg/bin") {
            Copy-DllsFromDir -srcDir "QtScrcpy/third_party/ffmpeg/bin" -dstDir $outDir -names $ffmpegDlls
          }

          $missing = @()
          foreach ($dll in $ffmpegDlls) {
            if (!(Test-Path (Join-Path $outDir $dll))) {
              $missing += $dll
            }
          }

          if ($missing.Count -gt 0) {
            $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl-shared.zip"
            Write-Host "FFmpeg DLLs missing after local copy: $($missing -join ', ')"
            Write-Host "Downloading FFmpeg shared build: $ffmpegUrl"

            $tmpDir = Join-Path $env:RUNNER_TEMP "ffmpeg-shared"
            if (Test-Path $tmpDir) {
              Remove-Item $tmpDir -Recurse -Force
            }
            New-Item -ItemType Directory -Force -Path $tmpDir | Out-Null

            $zipPath = Join-Path $tmpDir "ffmpeg.zip"
            Invoke-WebRequest -Uri $ffmpegUrl -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath $tmpDir -Force

            $avcodec = Get-ChildItem -Path $tmpDir -Recurse -Filter "avcodec-62.dll" -File | Select-Object -First 1
            if (!$avcodec) {
              throw "Failed to find avcodec-62.dll in FFmpeg build"
            }
            $ffmpegBinDir = Split-Path $avcodec.FullName -Parent
            Write-Host "Using FFmpeg DLL directory: $ffmpegBinDir"

            # Copy required FFmpeg core DLLs.
            foreach ($dll in $ffmpegDlls) {
              $src = Join-Path $ffmpegBinDir $dll
              if (!(Test-Path $src)) {
                throw "Missing $dll inside FFmpeg build at $ffmpegBinDir"
              }
              Copy-Item $src $outDir -Force
            }

            # Also copy any extra DLLs in the same directory (codec deps, etc.) to avoid 0xC0000135.
            Get-ChildItem -Path $ffmpegBinDir -Filter "*.dll" -File |
              ForEach-Object { Copy-Item $_.FullName $outDir -Force }
          }

          foreach ($dll in $ffmpegDlls) {
            $p = Join-Path $outDir $dll
            if (!(Test-Path $p)) {
              throw "FFmpeg DLL missing in output directory: $dll"
            }
          }
          Write-Host "FFmpeg DLLs present in build output:"
          foreach ($dll in $ffmpegDlls) {
            $p = Join-Path $outDir $dll
            $fi = Get-Item $p
            Write-Host "$($fi.Name) $($fi.Length)"
          }

          $releaseDir = Join-Path (Resolve-Path ".").Path "release"
          New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null
          $pkgDir = Join-Path $releaseDir "QtScrcpy-win-x64"
          if (Test-Path $pkgDir) {
            Remove-Item $pkgDir -Recurse -Force
          }
          New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
          Copy-Item "$outDir/*" $pkgDir -Recurse -Force

          foreach ($dll in $ffmpegDlls) {
            if (!(Test-Path (Join-Path $pkgDir $dll))) {
              throw "FFmpeg DLL missing in package directory: $dll"
            }
          }

          $runDebugLines = @(
            '@echo off'
            'setlocal'
            'cd /d %~dp0'
            'echo === QtScrcpy debug run ===> log.txt'
            'echo %date% %time%>> log.txt'
            'set QT_DEBUG_PLUGINS=1'
            'set QT_LOGGING_TO_CONSOLE=1'
            'QtScrcpy.exe 1>> log.txt 2>>&1'
            'echo ExitCode=%errorlevel%>> log.txt'
            'pause'
          )
          Set-Content -Path (Join-Path $pkgDir "run_debug.bat") -Value $runDebugLines -Encoding ASCII

          $buildInfo = @(
            "GitHub Repo: $env:GITHUB_REPOSITORY"
            "GitHub SHA:  $env:GITHUB_SHA"
            "Run ID:      $env:GITHUB_RUN_ID"
            "Run Number:  $env:GITHUB_RUN_NUMBER"
            "Built At:    $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss K')"
          ) -join "`r`n"
          Set-Content -Path (Join-Path $pkgDir "BUILD_INFO.txt") -Value $buildInfo -Encoding ASCII

          $zipPath = Join-Path $releaseDir "QtScrcpy-win-x64.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          Compress-Archive -Path "$pkgDir/*" -DestinationPath $zipPath

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QtScrcpy-win-x64
          path: |
            release/QtScrcpy-win-x64.zip
            release/QtScrcpy-win-x64/**

      - name: Publish asset to tagged release
        if: github.ref == 'refs/heads/main'
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "v3.0.0-delivery-20260210"
          $asset = "release/QtScrcpy-win-x64.zip"
          $max = 5

          for ($i = 1; $i -le $max; $i++) {
            Write-Host "Uploading release asset (attempt $i/$max): $asset"
            gh release upload $tag $asset --clobber
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Upload succeeded."
              exit 0
            }

            if ($i -eq $max) {
              throw "gh release upload failed after $max attempts (exit code: $LASTEXITCODE)"
            }

            Start-Sleep -Seconds (5 * $i)
          }
